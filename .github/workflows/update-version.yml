name: Auto Update LobeHub Version

on:
  schedule:
    # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00) è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Check, Update and Notify
        id: update_script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
        run: |
          python -c "
          import re
          import json
          import os
          import urllib.request
          import sys
          import html

          # --- é…ç½® ---
          file_path = 'README.md'
          api_url = 'https://api.github.com/repos/lobehub/lobehub/releases'

          def get_semver(ver_str):
              clean_ver = ver_str.lstrip('v')
              return [int(x) for x in clean_ver.split('.') if x.isdigit()]

          def send_telegram(token, chat_id, version, body):
              if not token or not chat_id:
                  print('::warning::Telegram secrets not set.')
                  return
    
              # 1. è§£ç  HTML å®ä½“
              decoded_body = html.unescape(body)
              print(f'   Decoded body preview: {decoded_body[:100]}...')
    
              # 2. **å…³é”®ï¼šè·³è¿‡ GitHub headerï¼Œåªå– changelog éƒ¨åˆ†**
              # åŒ¹é…å¼€å¤´çš„ "## [Version ...]\n<sup>Released...</sup>\n\n" åˆ°ç¬¬ä¸€ä¸ª #### æ ‡é¢˜
              header_pattern = r'^##\s+\[Version[^\n]*?\n(?:<sup>.*?</sup>\n)*\s*\n+'
              changelog_body = re.sub(header_pattern, '', decoded_body, flags=re.MULTILINE)
    
              # 3. æ¸…ç†æ ‡ç­¾
              cleaned = re.sub(r'<details>.*?</details>', '', changelog_body, flags=re.DOTALL | re.IGNORECASE)
              cleaned = re.sub(r'<br\s*/?>', '\n', cleaned, flags=re.IGNORECASE)
              cleaned = re.sub(r'\n\s*\n\s*\n+', '\n\n', cleaned)
              cleaned = re.sub(r'<div align=\"right\">.*?</div>', '', cleaned, flags=re.DOTALL | re.IGNORECASE)
              cleaned = re.sub(r'\[!?\]\(#readme-top\)', '', cleaned)
    
              # 4. é“¾æ¥è½¬æ¢
              link_pattern = r'\[([^\]]+)\]\((https?://[^)\s]+)\)'
              def link_replacer(match):
                  text = match.group(1)
                            url = match.group(2)
                  return f'<a href=\"{url}\">{text}</a>'
              cleaned = re.sub(link_pattern, link_replacer, cleaned)
    
              # 5. è½¬ä¹‰ + æ„å»º
              final_body = html.escape(cleaned)
              title_link = f'<a href=\"https://github.com/lobehub/lobe-chat/releases/tag/{version}\">{version}</a>'
              text_content = f'ğŸš€ <b>LobeHub (Choreo) Update Detected!</b>\\n\\n<b>New Version:</b> {title_link}\\n\\n{final_body}'
    
              if len(text_content) > 4000:
                  text_content = text_content[:4000] + '\\n\\n<i>(truncated)</i>'
    
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              payload = {
                  'chat_id': chat_id,
                  'text': text_content,
                  'parse_mode': 'HTML',
                  'disable_web_page_preview': False
              }
              headers = {'Content-Type': 'application/json'}
    
              try:
                  req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers)
                  urllib.request.urlopen(req)
                  print('-> Telegram sent (header cleaned)')
              except Exception as e:
                  print(f'::error::Send failed: {e}')
                  payload['parse_mode'] = None
                  payload['text'] = f'LobeHub Pre-Release: {version}\\n\\n{cleaned[:2000]}...'
                  try:
                      urllib.request.urlopen(urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers))
                      print('-> Plain text fallback.')
                  except Exception as e2:
                      print(f'::error::Fallback failed: {e2}')

      - name: Commit and Push changes
        if: steps.update_script.outputs.updated == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update to ${{ steps.update_script.outputs.new_version }} (pre-release)"
          git push

  cleanup-runs:
    runs-on: ubuntu-latest
    needs: check-and-update
    if: always()
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 6
